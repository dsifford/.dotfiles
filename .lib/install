#!/usr/bin/env bash
set -e

shopt -s extglob nullglob

[[ $USER == 'root' ]] && {
    echo "Don't run this as root."
    exit 1
}

declare config_dir=~/.dotfiles/.lib/config
# Array of files to be included in the GENERATED section of the config file
declare -a generated=()
# Extra args to be passed to dotbot
declare -a args=()

# Add generated files to the queue only if this isn't the very first run on a
# system. Using the $DOTFILES env variable because if that is set, then that
# means ~/.profile has been linked already and this has ran at least once.
if [[ -n $DOTFILES ]]; then
    generated+=("$config_dir"/generated/packages.*.yml)
fi

while test $# -gt 0; do
    case "$1" in
        --packages)
            generated+=("$config_dir"/generated/os.packages."$(uname)".yml)
            shift
            ;;
        *)
            args+=("$1")
            shift
            ;;
    esac
done

dotbot \
    --base-directory ~/.dotfiles \
    --plugin-dir ~/.dotfiles/.lib/plugins \
    --config-file <(
        sed --posix -e '/^# %{[A-Z_]*}%.*$/{
            /GENERATED/{
                '"$(for f in "${generated[@]}"; do echo "r $f"; done)"'
                d
            }
            /OS_SPECIFIC/{
                r '"$config_dir/config.$(uname).yml"'
                d
            }
        }' "$config_dir"/config.yml
    ) \
    "${args[@]}"
