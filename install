#!/usr/bin/env bash
# shellcheck disable=SC1090
USAGE='
Install and synchronize dotfiles into system.

Usage:
    install [-p] [--] [<dotbot-args>...]
    install [-h]

Options:
    -h --help      Show program help.
    -p --packages  Include system packages in installation.
'
set -e
shopt -s extglob nullglob

[[ $USER == root ]] && {
    echo "Don't run this as root."
    exit 1
}

# Ensure we have all environment variables loaded, even on fresh systems
source ~/.dotfiles/profile

declare config_dir="${DOTFILES?}"/.lib/config
# Array of files to be included in the GENERATED section of the config file
declare -a generated=("$config_dir"/generated/packages.*.yml)

if ! OPTS=$(getopt -o 'hp' --long 'help,packages' -n 'install' -- "$@"); then
    exit 1
fi
eval set -- "$OPTS"
unset OPTS

while true; do
    case "$1" in
        -h | --help)
            echo "$USAGE"
            exit
            ;;
        -p | --packages)
            generated+=("$config_dir"/generated/os.packages."$(uname)".yml)
            shift
            ;;
        --)
            shift
            break
            ;;
        *)
            exit 1
            ;;
    esac
done

dotbot \
    --base-directory "$DOTFILES" \
    --plugin-dir "$DOTFILES"/.lib/plugins \
    --config-file <(
        sed --posix -e '/^# %{[A-Z_]*}%.*$/{
            /GENERATED/{
                '"$(for f in "${generated[@]}"; do echo "r $f"; done)"'
                d
            }
            /OS_SPECIFIC/{
                r '"$config_dir/config.$(uname).yml"'
                d
            }
        }' "$config_dir"/config.yml
    ) \
    "$@"
