#!/usr/bin/env bash
# shellcheck disable=SC1090

[[ ! -f /usr/bin/python ]] && echo "Python must be installed first." && exit 1
[[ $EUID == 0 || $HOME == '/root' ]] && echo "Don't run this as root." && exit 1

config="install.conf.$(uname -n).yml"
dotbot_dir="dotbot"
dotbot_bin="bin/dotbot"
basedir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

args=()
while test $# -gt 0; do
    case "$1" in
        --packages)
            [[ $(uname -n) == 'archlinux' ]] && args+=( --plugin-dir "$basedir/plugins/dotbot-pacaur" ) && args+=( -c "$basedir/packages.yml" )
            [[ $(uname -n) == 'osx' ]] && args+=( --plugin-dir "$basedir/plugins/dotbot-brew" ) && args+=( -c "$basedir/packages.yml" )
            shift
            ;;
        *)
            args+=( "$1" )
            shift
            ;;
    esac
done

# Update bash-completions
. "$basedir/completions/.sources.sh"

# Exit immediately on exit failures
set -e

# Get secure files from lastpass
lpass show --notes taskwarrior-ca > ~/.task/freecinc.ca.pem
lpass show --notes taskwarrior-cert > ~/.task/freecinc.cert.pem
lpass show --notes taskwarrior-key > ~/.task/freecinc.key.pem

cd "$basedir"
git submodule update --remote --merge

"${basedir}/${dotbot_dir}/${dotbot_bin}" -d "${basedir}" -c "${config}" "${args[@]}"
