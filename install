#!/usr/bin/env bash
# shellcheck disable=SC1090
set -e

[[ $USER == 'root' ]] && {
    echo "Don't run this as root."
    exit 1
}

command -v python3 >/dev/null || {
    echo "Python 3 must be installed first."
    exit 1
}

command -v dotbot >/dev/null || {
    echo "dotbot must be installed first."
    exit 1
}

dotfiles="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
dotbot_plugins="$dotfiles/.lib/plugins"
config_dir="$dotfiles/.lib/config"
configs=(
    "$config_dir/config.yml"
    "$config_dir/config.$(uname).yml"
)

args=()
while test $# -gt 0; do
    case "$1" in
        --packages)
            configs+=(
                "$config_dir/packages.$(uname).yml"
            )
            shift
            ;;
        *)
            args+=("$1")
            shift
            ;;
    esac
done

dotbot -d "$dotfiles" -c <(cat "${configs[@]}") --plugin-dir "$dotbot_plugins" "${args[@]}"
